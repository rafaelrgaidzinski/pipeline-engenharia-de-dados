## Processo para provisionamento de um ambiente na Azure com terraform


Os seguintes itens são provisionados no ambiente Azure:

- SQL Server
- Data Lake Storage
- Databricks Workspace

### Passo a passo para executar o terraform e criar o ambiente:

#### 1. Efetue o login na Azure através do Azure CLI.
```bash
az login
```
#### 2. Valide sua assinatura atual.
```bash
az account list -o table
```
#### 3. (Opcional) Caso não seja a assinatura desejada, selecione-a através do comando abaixo.
```bash
az account set --subscription "Nome ou ID da Subscription"
```
#### 4. Criar a service principal na sua assinatura atual.
```bash
az ad sp create-for-rbac --name "terraform-databricks-sp" --role Contributor --scopes /subscriptions/numero_da_sua_subscription
```
#### O resultado da execução do comando acima, será o JSON que segue abaixo.

```json
{
  "appId": " -- azure_client_id -- ",        #(o ID do aplicativo)
  "displayName": "terraform-databricks-sp", 
  "password": " -- azure_client_secret -- ", #(a senha do Service Principal)
  "tenant": " -- azure_tenant_id -- "        #(o ID do tenant da sua organização)
}
```

#### 5. As variáveis devem ser preenchidas no arquivo `variables.tf` com seus respectivos valores, conforme exemplo abaixo:

#### Variáveis do Data Lake Storage:

```
subscription_id     = "00000000-ffff-0000-0000-ffffffffffff"
resource_group_name = "rg-iac-data-engineering"
```


#### Variáveis do Databricks Workspace:

```
azure_client_id     = "22222222-bbbb-2222-2222-bbbbbbbbbbbb"
azure_client_secret = "AA.AA~FffFFfff_FFFFFfFFFFFffFf-fFfffffff"
azure_tenant_id     = "11111111-aaaa-1111-1111-aaaaaaaaaaaa"
workspace_name      = "ws-iac-data-engineering"
```


#### Variáveis do SQL Server:

```
usuario_admin       = "nome_do_usuario"
password            = "sua_senha_forte"
```

#### 6. Criar os recursos na assinatura Azure selecionada

##### 6.1. Inicializar o Terraform na pasta atual
```bash copy
terraform init
```
##### 6.2. Validar os Códigos do Terraform nos arquivos .tf
```bash copy
terraform validate
```
##### 6.3. Ajustar a formatação dos arquivos .tf
```bash copy
terraform fmt
```
##### 6.4. Gerar um plano de implantação do Terraform
```bash copy
terraform plan
```
##### 6.5. Implantar os Códigos do Terraform na cloud - assinatura MS LEARN SANDBOX
```bash copy
terraform apply
```
##### 6.6. Logar no portal do Azure e validar a criação do Azure Data Lake Storage Gen2
9. Logar no [portal.azure.com](https://portal.azure.com/) e conferir o deploy do ADLS.

##### 6.7. Remover todos os recursos implantados na cloud - assinatura MS LEARN SANDBOX
10. Destruir os recursos criados.
```bash copy
terraform destroy
```